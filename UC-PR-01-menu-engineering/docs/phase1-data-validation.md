# UC-PR-01: Phase 1 — Data Validation & Schema Discovery

**Date:** 2026-02-16
**Status:** COMPLETE

---

## 1. Data Sources

### 1.1 Primary Tables

| Database | Table | Rows | Purpose |
|----------|-------|------|---------|
| scmcommodity | t_commodity | 656,229 | Product formulas (formula_json) |
| scm-ordering | t_commodity | — | Order-level commodity records |
| scm-ordering | t_formula_spu | — | SPU formula mappings |
| scm-ordering | t_commodity_base_info | — | Base product info (spu_code, name) |
| opshopsale | t_order | — | Orders (timestamps, totals, status) |
| opshopsale | t_order_item | — | Line items (48 columns: prices, qty, discounts) |
| opshop | t_shop | — | Store reference (10 Manhattan stores) |
| opproduction | t_production_plan | — | Production planning records |

### 1.2 Schema Discovery Results

- **656,229 rows** in `scmcommodity.t_commodity`, all with populated `formula_json`
- Each formula contains **1–12 ingredients** with `goodsCode`, `cost` (quantity), `unitCode`
- **CRITICAL FINDING:** The `cost` field in `formula_json` represents **QUANTITY**, not monetary cost

### 1.3 Unit Codes

| Code | Unit | Usage |
|------|------|-------|
| QU005 | grams (g) | Dry ingredients, coffee beans, powders |
| QU009 | pieces/each | Cups, lids, sleeves, food items |
| QU013 | milliliters (ml) | Liquids, milk, syrups |
| QU012 | equipment | Machines, dispensers |
| QU042 | equipment | Machines, dispensers |

---

## 2. Cost Data Investigation

### 2.1 Three Cost Paths Evaluated

| Path | Method | Result |
|------|--------|--------|
| **A — Direct cost** | Use `formula_json.cost` as dollar amount | **INVALIDATED** — field is quantity, not cost |
| **B — Qty × Procurement** | Multiply quantity by purchasing unit price | **NO DATA** — no procurement/pricing tables found |
| **C — Hybrid estimate** | Qty × estimated US wholesale price | **SELECTED** — viable with market price research |

### 2.2 Procurement Data Search

Searched 4 databases (`scmcommodity`, `scm-ordering`, `scm-purchase`, `pubdm`) for pricing data:
- No `unit_price`, `purchase_price`, or `cost_per_unit` columns found
- No procurement/purchasing transaction tables
- **Conclusion:** Luckin USA likely uses centralized (China-based) procurement — pricing data not in US databases

---

## 3. Revenue Model Validation

### 3.1 Price Fields in `t_order_item`

| Field | Description | Example |
|-------|-------------|---------|
| `origin_price` | Menu/list price | $7.99 |
| `sale_price` | After promotions | $3.99 |
| `pay_money` | Actual amount paid | $3.99 |
| `refund_money` | Refund amount | $0.00 |
| `tax_rate` | NYC sales tax | 0.08875 |

### 3.2 Discount Depth

- Average discount across all products: **~50%**
- Heavy discounting is a core business strategy (app-only model)
- Revenue calculations use `pay_money` (actual collected) not `origin_price`

---

## 4. Ingredient Mapping

### 4.1 Key Ingredient Categories

| Category | Goods Codes | Count |
|----------|-------------|-------|
| Coffee beans | GC000001–GC000005 | 5 |
| Milk & dairy | GC000010–GC000014 | 5 |
| Syrups & sweeteners | GC000020–GC000022 | 3 |
| Matcha & tea | GC000030–GC000032 | 3 |
| Packaging | GC000040–GC000045 | 6 |

### 4.2 Pre-Mix (PFM) Products

Several ingredients are proprietary pre-mixes combining multiple raw materials:
- **PFM000020** — Matcha pre-mix (most impactful on COGS)
- **PFM000029** — Specialty pre-mix
- **PFM000005** — Base pre-mix

These required special calibration in Phase 2 cost modeling.

---

## 5. Cross-Database Join Paths

```
t_order_item.spu_code → t_commodity_base_info.spu_code    (product lookup)
t_order_item.id → t_commodity.order_commodity_id           (formula lookup)
formula_json[].goodsCode → t_mdm_goods.mid                (ingredient details)
```

### 5.1 JSON Parsing Strategy

MySQL JSON extraction for `formula_json` array:
```sql
JSON_EXTRACT(formula_json, '$[0].cost')   -- First ingredient quantity
JSON_EXTRACT(formula_json, '$[0].goodsCode')  -- First ingredient code
-- Through $[11] for max 12 ingredients per formula
```

> **Note:** `JSON_TABLE` is not available on this MySQL version; index-based `JSON_EXTRACT` is required.

---

## 6. Data Quality Issues

| Issue | Impact | Resolution |
|-------|--------|------------|
| `cost` field is quantity, not cost | Cannot use direct cost path | Use hybrid estimation (Path C) |
| No procurement pricing data | Cannot calculate exact COGS | Use US wholesale market prices |
| ~50% discount depth | Revenue significantly below list price | Use `pay_money` for actual revenue |
| Pre-mix formulas opaque | Cannot break down PFM ingredient costs | Calibrate PFM prices as unit costs |
| Some SPUs lack formula data | Cannot cost 25 of 83 SPUs | Mark as "Uncosted" in classification |

---

*Generated by Claude Code — UC-PR-01 Menu Engineering Matrix*
